// This file was generated by Mendix Modeler.
//
// WARNING: Only the following code will be retained when actions are regenerated:
// - the import list
// - the code between BEGIN USER CODE and END USER CODE
// - the code between BEGIN EXTRA CODE and END EXTRA CODE
// Other code you write will be lost the next time you deploy the project.
// Special characters, e.g., é, ö, à, etc. are supported in comments.

package importexport.actions;

import audit.proxies.AuditRecord;
import com.mendix.core.Core;
import com.mendix.systemwideinterfaces.core.IMendixObject;
import importexport.proxies.DataPatchRecord;
import importexport.proxies.ImportActionEnum;
import java.util.Date;
import java.util.List;
import nl.mansystems.audit.AuditFunctions;
import nl.mansystems.mendiximportexport.SharedFunctions;
import com.mendix.systemwideinterfaces.core.IContext;
import com.mendix.webui.CustomJavaAction;

public class CopyToDataPatchRecordList extends CustomJavaAction<java.lang.Boolean>
{
	private java.util.List<IMendixObject> __AuditRecordList;
	private java.util.List<audit.proxies.AuditRecord> AuditRecordList;
	private IMendixObject __DataPatchSetParameter1;
	private importexport.proxies.DataPatchSet DataPatchSetParameter1;

	public CopyToDataPatchRecordList(IContext context, java.util.List<IMendixObject> AuditRecordList, IMendixObject DataPatchSetParameter1)
	{
		super(context);
		this.__AuditRecordList = AuditRecordList;
		this.__DataPatchSetParameter1 = DataPatchSetParameter1;
	}

	@Override
	public java.lang.Boolean executeAction() throws Exception
	{
		this.AuditRecordList = new java.util.ArrayList<audit.proxies.AuditRecord>();
		if (__AuditRecordList != null)
			for (IMendixObject __AuditRecordListElement : __AuditRecordList)
				this.AuditRecordList.add(audit.proxies.AuditRecord.initialize(getContext(), __AuditRecordListElement));

		this.DataPatchSetParameter1 = __DataPatchSetParameter1 == null ? null : importexport.proxies.DataPatchSet.initialize(getContext(), __DataPatchSetParameter1);

		// BEGIN USER CODE
		Core.getLogger("CopyToDataPatchRecordList").trace("CopyToDataPatchRecordList: Starting with "+(AuditRecordList==null?"0":AuditRecordList.size())+" audit records.");
		Date dumpDate = DataPatchSetParameter1.getDumpDate();
		if(dumpDate!=null) Core.getLogger("CopyToDataPatchRecordList").trace("CopyToDataPatchRecordList: Dump Date: " + dumpDate.toString());

		for(AuditRecord auditRecord:AuditRecordList) {
			ImportActionEnum importActionEnum = nl.mansystems.mendiximportexport.ExportToExcelWithContents.getActionEnumByAudit(this.getContext(), dumpDate,	true, auditRecord, true);
			if (importActionEnum!=null) {
				DataPatchRecord dataPatchRecord = nl.mansystems.mendiximportexport.ExportToExcelWithContents.insertOrUpdateDataPatchRecordByAudit(this.getContext(), auditRecord, DataPatchSetParameter1, importActionEnum);
				if (dataPatchRecord!=null) this.addRefreshObjectFeedback(dataPatchRecord.getMendixObject().getId());
				if (!importActionEnum.equals(ImportActionEnum.Delete)) {
					List<IMendixObject> iMendixObjectList =  nl.mansystems.mendiximportexport.ExportToExcelWithContents.getRelatedObjects(this.getContext(), auditRecord.getEntityName(),  auditRecord.getMendixID(), 0);
					if (iMendixObjectList!=null) for (IMendixObject iMendixObject:iMendixObjectList) {
						AuditRecord auditChildRecord = AuditFunctions.findAuditRecord(this.getContext(), SharedFunctions.getEntityInfo(this.getContext(), iMendixObject.getType(),0), iMendixObject, "find audit of related record in export", false);
						ImportActionEnum importChildActionEnum = nl.mansystems.mendiximportexport.ExportToExcelWithContents.getActionEnumByAudit(this.getContext(), dumpDate,	true, auditChildRecord, true);
						DataPatchRecord dataPatchChildRecord = nl.mansystems.mendiximportexport.ExportToExcelWithContents.insertOrUpdateDataPatchRecordByAudit(this.getContext(), auditChildRecord, DataPatchSetParameter1, importChildActionEnum);						
						if (dataPatchChildRecord!=null) this.addRefreshObjectFeedback(dataPatchChildRecord.getMendixObject().getId());
					}
				}
				
			}
		}
		
		Core.getLogger("CopyToDataPatchRecordList").trace("CopyToDataPatchRecordList: Finished.");
		return true;
		// END USER CODE
	}

	/**
	 * Returns a string representation of this action
	 */
	@Override
	public java.lang.String toString()
	{
		return "CopyToDataPatchRecordList";
	}

	// BEGIN EXTRA CODE
	// END EXTRA CODE
}
